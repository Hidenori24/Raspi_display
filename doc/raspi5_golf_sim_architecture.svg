<svg viewBox="0 0 1200 800" xmlns="http://www.w3.org/2000/svg">
  <!-- Define styles -->
  <defs>
    <style>
      .box { fill: #e8f4f8; stroke: #2c3e50; stroke-width: 2; }
      .input-box { fill: #fff4e6; stroke: #d97706; stroke-width: 2; }
      .process-box { fill: #e0e7ff; stroke: #4f46e5; stroke-width: 2; }
      .output-box { fill: #dcfce7; stroke: #16a34a; stroke-width: 2; }
      .arrow { stroke: #2c3e50; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .label { font-family: 'Courier New', monospace; font-size: 14px; font-weight: bold; }
      .sublabel { font-family: 'Courier New', monospace; font-size: 12px; }
      .title { font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#2c3e50" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="30" text-anchor="middle" class="title">Raspberry Pi 5 Golf Simulator - System Architecture</text>

  <!-- ============== INPUT LAYER (Left) ============== -->
  <!-- Sensor Sources -->
  <rect x="20" y="80" width="140" height="100" class="input-box" rx="5"/>
  <text x="90" y="105" text-anchor="middle" class="label">Sensor Sources</text>
  <text x="90" y="130" text-anchor="middle" class="sublabel">Real / Mock</text>
  <text x="90" y="150" text-anchor="middle" class="sublabel">Replay</text>

  <!-- ISensorProvider Interface -->
  <rect x="20" y="220" width="140" height="80" class="box" rx="5"/>
  <text x="90" y="240" text-anchor="middle" class="label">ISensorProvider</text>
  <text x="90" y="265" text-anchor="middle" class="sublabel">poll(SensorFrame)</text>

  <!-- ============== PROCESSING LAYER (Center-Left) ============== -->
  <!-- Input Adapter -->
  <rect x="200" y="80" width="140" height="100" class="process-box" rx="5"/>
  <text x="270" y="105" text-anchor="middle" class="label">Input Adapter</text>
  <text x="270" y="130" text-anchor="middle" class="sublabel">Normalize</text>
  <text x="270" y="150" text-anchor="middle" class="sublabel">Filter / Detect</text>

  <!-- EventQueue -->
  <rect x="200" y="220" width="140" height="80" class="process-box" rx="5"/>
  <text x="270" y="240" text-anchor="middle" class="label">EventQueue</text>
  <text x="270" y="265" text-anchor="middle" class="sublabel">SPSC RingBuffer</text>

  <!-- ============== CORE LOGIC LAYER (Center-Right) ============== -->
  <!-- GameStateMachine -->
  <rect x="400" y="80" width="140" height="100" class="process-box" rx="5"/>
  <text x="470" y="105" text-anchor="middle" class="label">GameState</text>
  <text x="470" y="130" text-anchor="middle" class="sublabel">Machine (FSM)</text>
  <text x="470" y="150" text-anchor="middle" class="sublabel">Idle/Armed/InFlight</text>

  <!-- Physics Engine -->
  <rect x="400" y="220" width="140" height="100" class="process-box" rx="5"/>
  <text x="470" y="245" text-anchor="middle" class="label">Physics Engine</text>
  <text x="470" y="270" text-anchor="middle" class="sublabel">Fixed Timestep</text>
  <text x="470" y="290" text-anchor="middle" class="sublabel">(Deterministic)</text>

  <!-- ============== OUTPUT LAYER (Right) ============== -->
  <!-- Renderer/UI -->
  <rect x="600" y="80" width="140" height="100" class="output-box" rx="5"/>
  <text x="670" y="105" text-anchor="middle" class="label">Renderer</text>
  <text x="670" y="130" text-anchor="middle" class="sublabel">2D Top View</text>
  <text x="670" y="150" text-anchor="middle" class="sublabel">HUD (raylib)</text>

  <!-- Display/HDMI -->
  <rect x="600" y="220" width="140" height="80" class="output-box" rx="5"/>
  <text x="670" y="245" text-anchor="middle" class="label">Display</text>
  <text x="670" y="270" text-anchor="middle" class="sublabel">HDMI Output</text>

  <!-- Logger -->
  <rect x="780" y="220" width="140" height="80" class="box" rx="5"/>
  <text x="850" y="245" text-anchor="middle" class="label">Logger</text>
  <text x="850" y="270" text-anchor="middle" class="sublabel">CSV/JSON Events</text>

  <!-- ============== DETAILED COMPONENTS (Bottom) ============== -->
  <!-- Event Structure -->
  <rect x="20" y="380" width="180" height="120" class="box" rx="5"/>
  <text x="110" y="400" text-anchor="middle" class="label">Event (Internal)</text>
  <text x="110" y="425" text-anchor="middle" class="sublabel">EventType</text>
  <text x="110" y="445" text-anchor="middle" class="sublabel">t_sec</text>
  <text x="110" y="465" text-anchor="middle" class="sublabel">SensorFrame</text>

  <!-- BallState Structure -->
  <rect x="220" y="380" width="180" height="120" class="box" rx="5"/>
  <text x="310" y="400" text-anchor="middle" class="label">BallState</text>
  <text x="310" y="425" text-anchor="middle" class="sublabel">pos (Vec3)</text>
  <text x="310" y="445" text-anchor="middle" class="sublabel">vel (Vec3)</text>
  <text x="310" y="465" text-anchor="middle" class="sublabel">spin / in_flight</text>

  <!-- ShotResult Structure -->
  <rect x="420" y="380" width="180" height="120" class="box" rx="5"/>
  <text x="510" y="400" text-anchor="middle" class="label">ShotResult</text>
  <text x="510" y="425" text-anchor="middle" class="sublabel">carry_m</text>
  <text x="510" y="445" text-anchor="middle" class="sublabel">total_m / lateral_m</text>
  <text x="510" y="465" text-anchor="middle" class="sublabel">flight_time_s</text>

  <!-- FSM States -->
  <rect x="620" y="380" width="180" height="120" class="box" rx="5"/>
  <text x="710" y="400" text-anchor="middle" class="label">FSM States</text>
  <text x="710" y="425" text-anchor="middle" class="sublabel">Idle / Armed</text>
  <text x="710" y="445" text-anchor="middle" class="sublabel">InFlight / Result</text>
  <text x="710" y="465" text-anchor="middle" class="sublabel">Transitions</text>

  <!-- Config/JSON -->
  <rect x="820" y="380" width="180" height="120" class="box" rx="5"/>
  <text x="910" y="400" text-anchor="middle" class="label">Config (JSON)</text>
  <text x="910" y="425" text-anchor="middle" class="sublabel">sim.json</text>
  <text x="910" y="445" text-anchor="middle" class="sublabel">clubs.json</text>
  <text x="910" y="465" text-anchor="middle" class="sublabel">Physics / Render</text>

  <!-- ============== DATA FLOW ARROWS ============== -->
  <!-- Sensor -> ISensorProvider -->
  <path d="M 90 180 L 90 220" class="arrow"/>

  <!-- ISensorProvider -> InputAdapter -->
  <path d="M 160 250 L 200 250" class="arrow"/>

  <!-- InputAdapter -> EventQueue -->
  <path d="M 270 180 L 270 220" class="arrow"/>

  <!-- EventQueue -> GameStateMachine -->
  <path d="M 340 260 L 400 260" class="arrow"/>

  <!-- EventQueue -> Physics (Also feeds Physics) -->
  <path d="M 340 260 L 400 220" class="arrow"/>

  <!-- GameStateMachine -> Physics -->
  <path d="M 470 180 L 470 220" class="arrow"/>

  <!-- Physics -> Renderer -->
  <path d="M 540 270 L 600 270" class="arrow"/>

  <!-- Physics -> Logger -->
  <path d="M 540 270 L 780 270" class="arrow"/>

  <!-- Renderer -> Display -->
  <path d="M 670 180 L 670 220" class="arrow"/>

  <!-- ============== ANNOTATIONS ============== -->
  <text x="130" y="340" font-size="12" fill="#666">Phase 1:</text>
  <text x="130" y="358" font-size="12" fill="#666">Single Thread</text>

  <text x="530" y="340" font-size="12" fill="#666">Fixed dt:</text>
  <text x="530" y="358" font-size="12" fill="#666">240Hz</text>

  <text x="750" y="340" font-size="12" fill="#666">Target:</text>
  <text x="750" y="358" font-size="12" fill="#666">60 FPS</text>

  <!-- ============== MAIN LOOP ANNOTATION ============== -->
  <rect x="20" y="550" width="980" height="200" fill="none" stroke="#999" stroke-width="1" stroke-dasharray="5,5" rx="5"/>
  <text x="40" y="575" font-size="14" font-weight="bold" fill="#666">Main Loop (Pseudocode)</text>

  <text x="40" y="605" font-family="monospace" font-size="11" fill="#333">while (!renderer.shouldClose()) {</text>
  <text x="60" y="625" font-family="monospace" font-size="11" fill="#333">  // 1) Input polling (non-blocking)</text>
  <text x="60" y="645" font-family="monospace" font-size="11" fill="#333">  while (sensor-&gt;poll(f)) { inputAdapter.toEvent(f, ev); q.push(ev); }</text>

  <text x="60" y="670" font-family="monospace" font-size="11" fill="#333">  // 2) Drain events</text>
  <text x="60" y="690" font-family="monospace" font-size="11" fill="#333">  while (q.pop(ev)) { gsm.onEvent(ev, phys); logger.write(ev); }</text>

  <text x="60" y="715" font-family="monospace" font-size="11" fill="#333">  // 3) Physics (fixed timestep)  4) Render</text>
  <text x="60" y="735" font-family="monospace" font-size="11" fill="#333">  phys.step(dt);  renderer.draw(gsm, phys, q);</text>

  <text x="40" y="755" font-family="monospace" font-size="11" fill="#333">}</text>

  <!-- Legend -->
  <rect x="20" y="760" width="20" height="20" class="input-box" rx="2"/>
  <text x="50" y="775" font-size="12">Input Layer</text>

  <rect x="180" y="760" width="20" height="20" class="process-box" rx="2"/>
  <text x="210" y="775" font-size="12">Processing Layer</text>

  <rect x="400" y="760" width="20" height="20" class="output-box" rx="2"/>
  <text x="430" y="775" font-size="12">Output Layer</text>
</svg>
